<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Upload avec validation et fetch</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .error { color: red; }
  .success { color: green; }
  .preview { margin-top: 10px; }
</style>
</head>
<body>

<h2>Formulaire d'upload</h2>

<form id="uploadForm">
  <label for="fileInput">Choisir un fichier :</label>
  <input type="file" id="fileInput" required><br><br>

  <label for="dateInput">Choisir une date :</label>
  <input type="date" id="dateInput" required><br><br>

  <button type="submit" id="submitBtn" disabled>Envoyer</button>
</form>

<div id="errorMsg" class="error"></div>
<div id="successMsg" class="success"></div>
<div id="preview" class="preview"></div>

<script>
const fileInput = document.getElementById('fileInput');
const dateInput = document.getElementById('dateInput');
const submitBtn = document.getElementById('submitBtn');
const errorMsg = document.getElementById('errorMsg');
const successMsg = document.getElementById('successMsg');
const preview = document.getElementById('preview');

function validateForm() {
  errorMsg.textContent = '';
  successMsg.textContent = '';
  let valid = true;

  // Validation fichier
  const file = fileInput.files[0];
  if (!file) {
    valid = false;
  } else if (!['image/png','image/jpeg','application/pdf'].includes(file.type)) {
    errorMsg.textContent = 'Format de fichier invalide (PNG, JPEG ou PDF uniquement).';
    valid = false;
  } else if (file.size > 5 * 1024 * 1024) {
    errorMsg.textContent = 'Fichier trop lourd (max 5MB).';
    valid = false;
  }

  // Validation date
  const selectedDate = new Date(dateInput.value);
  const today = new Date();
  if (isNaN(selectedDate)) {
    valid = false;
  } else if (selectedDate > today) {
    errorMsg.textContent = 'La date ne peut pas être dans le futur.';
    valid = false;
  }

  submitBtn.disabled = !valid;

  // Prévisualisation si image
  if (file && file.type.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = e => {
      preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width:200px;">`;
    };
    reader.readAsDataURL(file);
  } else {
    preview.innerHTML = '';
  }
}

fileInput.addEventListener('change', validateForm);
dateInput.addEventListener('change', validateForm);

document.getElementById('uploadForm').addEventListener('submit', async e => {
  e.preventDefault();
  errorMsg.textContent = '';
  successMsg.textContent = '';

  const file = fileInput.files[0];
  const date = dateInput.value;

  if (!file || !date) return;

  // Préparation FormData pour l'envoi
  const formData = new FormData();
  formData.append('file', file);
  formData.append('date', date);

  try {
    const response = await fetch('/upload', {  // Remplace '/upload' par ton endpoint
      method: 'POST',
      body: formData
    });

    if (response.ok) {
      successMsg.textContent = 'Fichier et date envoyés avec succès !';
      // Réinitialiser le formulaire si nécessaire
      fileInput.value = '';
      dateInput.value = '';
      preview.innerHTML = '';
      submitBtn.disabled = true;
    } else {
      const errorText = await response.text();
      errorMsg.textContent = `Erreur serveur : ${errorText}`;
    }
  } catch (err) {
    errorMsg.textContent = `Erreur réseau : ${err.message}`;
  }
});
</script>

</body>
</html>
